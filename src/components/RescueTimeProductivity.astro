---
import { getCollection } from 'astro:content';

interface ProductivityDay {
  date: string
  seconds: number
  hours: number
  productivity: number
}

// Get productivity data from content collection
const productivityData = await getCollection('productivity');
const productivityPulseData = await getCollection('productivityPulse');

// Convert to our expected format and sort by date
const sortedData: ProductivityDay[] = productivityData
  .map(entry => ({
    date: entry.data.date,
    seconds: entry.data.seconds,
    hours: entry.data.hours,
    productivity: entry.data.productivity
  }))
  .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

console.log('üìä Loaded productivity data:', sortedData);

// Get the productivity pulse if available
const productivityPulse = productivityPulseData.length > 0 ? productivityPulseData[0].data : null;
console.log('üî• Loaded productivity pulse:', productivityPulse);

// Calculate summary statistics
const totalHours = Math.round(sortedData.reduce((sum, day) => sum + (day.hours || 0), 0) * 10) / 10;
const avgProductivity = totalHours > 0 ? 
  Math.round((sortedData.reduce((sum, day) => sum + (day.productivity || 0) * (day.hours || 0), 0) / totalHours) * 10) / 10 : 
  0;

function getProductivityColor(productivity: number): string {
  if (productivity >= 1.5) return '#22c55e' // Green - Very productive
  if (productivity >= 0.5) return '#84cc16' // Light green - Productive
  if (productivity >= -0.5) return '#eab308' // Yellow - Neutral
  if (productivity >= -1.5) return '#f97316' // Orange - Distracting
  return '#ef4444' // Red - Very distracting
}

function getProductivityLabel(productivity: number): string {
  if (productivity >= 1.5) return 'Very Productive'
  if (productivity >= 0.5) return 'Productive'
  if (productivity >= -0.5) return 'Neutral'
  if (productivity >= -1.5) return 'Distracting'
  return 'Very Distracting'
}

function getPulseDescription(pulse: number): { emoji: string, level: string, description: string, color: string } {
  if (pulse >= 85) return { emoji: 'üî•', level: 'Peak Performance', description: 'Exceptional focus', color: '#22c55e' }
  if (pulse >= 75) return { emoji: '‚ö°', level: 'High Energy', description: 'Strong productivity', color: '#84cc16' }
  if (pulse >= 60) return { emoji: 'üíö', level: 'Steady Flow', description: 'Good momentum', color: '#10b981' }
  if (pulse >= 45) return { emoji: 'üå±', level: 'Building Up', description: 'Finding rhythm', color: '#eab308' }
  if (pulse >= 30) return { emoji: 'üåô', level: 'Low Key', description: 'Taking it easy', color: '#f97316' }
  return { emoji: 'üí§', level: 'Rest Mode', description: 'Recharging', color: '#64748b' }
}

function formatDayName(dateStr: string): string {
  try {
    const date = new Date(dateStr)
    if (isNaN(date.getTime())) {
      const parts = dateStr.split('-')
      if (parts.length === 3) {
        const year = parseInt(parts[0])
        const month = parseInt(parts[1]) - 1
        const day = parseInt(parts[2])
        const parsedDate = new Date(year, month, day)
        return parsedDate.toLocaleDateString('en-US', { weekday: 'short' })
      }
      return 'N/A'
    }
    return date.toLocaleDateString('en-US', { weekday: 'short' })
  } catch (error) {
    console.error('Error formatting date:', dateStr, error)
    return 'N/A'
  }
}
---

<section class="rescuetime-section">
  <h2 class="section-title">‚è±Ô∏è Productivity Insights</h2>
  <p class="section-subtitle">My productivity journey over the last 7 days (live RescueTime data)</p>
  
  <article class="productivity-container">
    <!-- Productivity Pulse Section (if available) -->
    {productivityPulse && (
      <div class="productivity-pulse">
        <div class="pulse-header">
          <h3 class="pulse-title">üéØ Productivity Pulse</h3>
          <p class="pulse-description">A real-time measure of my focus and productivity</p>
        </div>
        <div class="pulse-display">
          <div class="pulse-score">
            <span class="pulse-emoji">{getPulseDescription(productivityPulse.pulse).emoji}</span>
            <span class="pulse-value" style={`color: ${getPulseDescription(productivityPulse.pulse).color}`}>
              {productivityPulse.pulse}
            </span>
            <span class="pulse-max">/100</span>
          </div>
          <div class="pulse-status">
            <span class="pulse-level" style={`color: ${getPulseDescription(productivityPulse.pulse).color}`}>
              {getPulseDescription(productivityPulse.pulse).level}
            </span>
            <span class="pulse-description">{getPulseDescription(productivityPulse.pulse).description}</span>
          </div>
        </div>
        <div class="pulse-breakdown">
          <div class="chart-container">
            <svg class="productivity-chart-circle" viewBox="0 0 200 200" width="240" height="240">
              <circle 
                cx="100" 
                cy="100" 
                r="70" 
                fill="none" 
                stroke="#f1f5f9" 
                stroke-width="40"
              />
              {(() => {
                let offset = 0;
                const radius = 70;
                const circumference = 2 * Math.PI * radius;
                const segments = [
                  { value: productivityPulse.breakdown.veryProductive, color: '#22c55e', label: 'Very Productive' },
                  { value: productivityPulse.breakdown.productive, color: '#84cc16', label: 'Productive' },
                  { value: productivityPulse.breakdown.neutral, color: '#eab308', label: 'Neutral' },
                  { value: productivityPulse.breakdown.distracting, color: '#f97316', label: 'Distracting' },
                  { value: productivityPulse.breakdown.veryDistracting, color: '#ef4444', label: 'Very Distracting' }
                ];
                
                return segments.map((segment, index) => {
                  const strokeDasharray = `${(segment.value / 100) * circumference} ${circumference}`;
                  const strokeDashoffset = -offset * circumference / 100;
                  offset += segment.value;
                  
                  return (
                    <circle
                      cx="100"
                      cy="100"
                      r={radius}
                      fill="none"
                      stroke={segment.color}
                      stroke-width="40"
                      stroke-dasharray={strokeDasharray}
                      stroke-dashoffset={strokeDashoffset}
                      transform="rotate(-90 100 100)"
                      class="chart-segment"
                      data-label={segment.label}
                      data-value={Math.round(segment.value)}
                    />
                  );
                });
              })()}
              <text x="100" y="100" text-anchor="middle" dominant-baseline="central" class="chart-pulse-value">
                {productivityPulse.pulse}
              </text>
            </svg>
            <div class="chart-tooltip" id="chart-tooltip"></div>
          </div>
        </div>
      </div>
    )}

    <!-- Summary Stats -->
    <div class="productivity-summary">
      <div class="summary-stat">
        <span class="stat-value">{totalHours}h</span>
        <span class="stat-label">Total Hours</span>
      </div>
      <div class="summary-stat">
        <span class="stat-value" style={`color: ${getProductivityColor(avgProductivity)}`}>
          {avgProductivity > 0 ? '+' : ''}{avgProductivity}
        </span>
        <span class="stat-label">Avg Productivity</span>
      </div>
      <div class="summary-stat">
        <span class="stat-value">{getProductivityLabel(avgProductivity)}</span>
        <span class="stat-label">Overall Trend</span>
      </div>
    </div>

    <!-- Daily Productivity Chart -->
    <div class="productivity-chart" id="productivity-chart">
      {sortedData.map((day) => (
        <div class="day-column">
          <div class="day-label">{formatDayName(day.date)}</div>
          <div 
            class="productivity-bar"
            style={`
              height: ${Math.max(((day.hours || 0) / 12) * 100, 10)}%;
              background-color: ${getProductivityColor(day.productivity || 0)};
            `}
            title={`${day.hours || 0}h - ${getProductivityLabel(day.productivity || 0)} (${(day.productivity || 0) > 0 ? '+' : ''}${day.productivity || 0})`}
          >
            <span class="bar-value">{day.hours || 0}h</span>
          </div>
          <div class="productivity-score" style={`color: ${getProductivityColor(day.productivity || 0)}`}>
            {(day.productivity || 0) > 0 ? '+' : ''}{day.productivity || 0}
          </div>
        </div>
      ))}
    </div>

    <!-- Productivity Scale Legend -->
    <div class="productivity-legend">
      <span class="legend-title">Productivity Scale:</span>
      <div class="legend-items">
        <div class="legend-item">
          <span class="legend-color" style="background-color: #ef4444"></span>
          <span>Very Distracting (-2)</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #f97316"></span>
          <span>Distracting (-1)</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #eab308"></span>
          <span>Neutral (0)</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #84cc16"></span>
          <span>Productive (+1)</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #22c55e"></span>
          <span>Very Productive (+2)</span>
        </div>
      </div>
    </div>
  </article>
</section>

<style>
  .rescuetime-section {
    margin: 4rem 0;
    text-align: center;
  }

  .section-title {
    font-size: 2.2rem;
    font-weight: 700;
    color: rgb(var(--black));
    margin-bottom: 0.5rem;
  }

  .section-subtitle {
    color: rgb(var(--gray-dark));
    font-size: 1.1rem;
    margin-bottom: 2rem;
  }

  .productivity-container {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    border: 1px solid rgb(var(--gray));
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    max-width: 800px;
    margin: 0 auto;
  }

  .productivity-pulse {
    background: linear-gradient(135deg, rgb(var(--gray-light)) 0%, rgba(255, 255, 255, 0.8) 100%);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  .pulse-header {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .pulse-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: rgb(var(--black));
    margin: 0 0 0.25rem 0;
  }

  .pulse-subtitle {
    font-size: 0.875rem;
    color: rgb(var(--gray-dark));
    margin: 0;
  }

  .pulse-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    margin-bottom: 1.5rem;
  }

  .pulse-score {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
  }

  .pulse-emoji {
    font-size: 2rem;
  }

  .pulse-value {
    font-size: 3rem;
    font-weight: 700;
  }

  .pulse-max {
    font-size: 1.25rem;
    color: rgb(var(--gray));
    font-weight: 500;
  }

  .pulse-status {
    text-align: center;
  }

  .pulse-level {
    display: block;
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
  }

  .pulse-description {
    font-size: 0.875rem;
    color: rgb(var(--gray-dark));
  }

  .pulse-breakdown {
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  .chart-container {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .productivity-chart-circle {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    cursor: pointer;
  }

  .chart-segment {
    transition: stroke-width 0.3s ease, opacity 0.2s ease;
    cursor: pointer;
  }

  .chart-segment:hover {
    stroke-width: 44;
    opacity: 0.9;
  }

  .chart-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    pointer-events: none;
    opacity: 0;
    transform: translate(-50%, -100%);
    transition: opacity 0.2s ease;
    white-space: nowrap;
    z-index: 10;
    top: -10px;
    left: 50%;
  }

  .chart-tooltip.visible {
    opacity: 1;
  }

  .chart-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.9);
  }

  .chart-pulse-value {
    font-size: 36px;
    font-weight: 700;
    fill: rgb(var(--black));
    font-family: inherit;
  }

  .chart-pulse-label {
    font-size: 14px;
    font-weight: 500;
    fill: rgb(var(--gray-dark));
    font-family: inherit;
  }

  .productivity-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgb(var(--gray-light));
  }

  .summary-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: rgb(var(--black));
  }

  .stat-label {
    font-size: 0.875rem;
    color: rgb(var(--gray-dark));
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .productivity-chart {
    display: flex;
    justify-content: space-between;
    align-items: end;
    height: 200px;
    margin-bottom: 1.5rem;
    padding: 0 1rem;
    gap: 0.5rem;
  }

  .day-column {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
  }

  .day-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: rgb(var(--gray-dark));
    margin-bottom: 0.5rem;
  }

  .productivity-bar {
    flex: 1;
    width: 100%;
    max-width: 40px;
    border-radius: 4px 4px 0 0;
    display: flex;
    align-items: end;
    justify-content: center;
    padding: 0.25rem;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    min-height: 20px;
  }

  .productivity-bar:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  .bar-value {
    font-size: 0.75rem;
    font-weight: 600;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
  }

  .productivity-score {
    font-size: 0.875rem;
    font-weight: 600;
    margin-top: 0.5rem;
  }

  .productivity-legend {
    padding-top: 1.5rem;
    border-top: 1px solid rgb(var(--gray-light));
  }

  .legend-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: rgb(var(--gray-dark));
    margin-bottom: 1rem;
    display: block;
  }

  .legend-items {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: rgb(var(--gray-dark));
  }

  .legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  @media (max-width: 768px) {
    .rescuetime-section {
      margin: 2rem 0;
    }

    .section-title {
      font-size: 1.8rem;
    }

    .productivity-container {
      padding: 1.5rem;
    }

    .productivity-pulse {
      padding: 1rem;
    }

    .pulse-display {
      flex-direction: column;
      gap: 1rem;
    }

    .pulse-score {
      justify-content: center;
    }

    .pulse-breakdown {
      padding: 1.5rem;
    }

    .chart-container svg {
      width: 200px;
      height: 200px;
    }

    .productivity-summary {
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .productivity-chart {
      height: 150px;
      padding: 0 0.5rem;
    }

    .legend-items {
      gap: 0.5rem;
    }

    .legend-item {
      font-size: 0.7rem;
    }
  }

  @media (max-width: 480px) {
    .productivity-summary {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .pulse-breakdown {
      grid-template-columns: 1fr;
    }

    .pulse-value {
      font-size: 2.5rem;
    }

    .legend-items {
      flex-direction: column;
      align-items: center;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const chartSegments = document.querySelectorAll('.chart-segment');
    const tooltip = document.getElementById('chart-tooltip');
    
    chartSegments.forEach(segment => {
      segment.addEventListener('mouseenter', function(e) {
        const target = e.target as SVGElement;
        const label = target.getAttribute('data-label');
        const value = target.getAttribute('data-value');
        
        if (tooltip && label && value) {
          tooltip.textContent = `${label}: ${value}%`;
          tooltip.classList.add('visible');
        }
      });
      
      segment.addEventListener('mouseleave', function() {
        if (tooltip) {
          tooltip.classList.remove('visible');
        }
      });
      
      segment.addEventListener('mousemove', function(e) {
        const mouseEvent = e as MouseEvent;
        const target = e.target as SVGElement;
        
        if (tooltip && target) {
          const container = target.closest('.chart-container') as HTMLElement;
          if (container) {
            const rect = container.getBoundingClientRect();
            const x = mouseEvent.clientX - rect.left;
            const y = mouseEvent.clientY - rect.top;
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = (y - 10) + 'px';
          }
        }
      });
    });
  });
</script>